/*======================================================================
 *  Copyright 2017 Ivan Aug√©
 *
 *  This file is part of the YFIG software.
 * 
 *  YFIG is free  software;  you  can redistribute it and/or modify it
 *  under the terms of the GNU  General Public License as published by
 *  the  Free Software Foundation; either version 3 of the License, or
 *  (at your option) any later version.
 * 
 *  YFIG software is distributed  in the  hope that it will be useful,
 *  but WITHOUT ANY WARRANTY;  without even the  implied  warranty  of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See  the GNU
 *  General Public License for more details.
 * 
 *  You should have received  a copy of the GNU General Public License
 *  along with YFIG. If not, see <http://www.gnu.org/licenses/>.
**======================================================================
 * $Software: YFIG-FDS (Figure Data Structure)
 *      $Id: line.c 120 2018-01-28 16:19:13Z ia $
 * $HeadURL: http://lunix120.ensiie.fr/yfig/trunk/yfig/common/modepanel/line.c $
 *  $Author: Ivan Auge (Email: auge@ensiie.fr)
**======================================================================*/

/*======================================================================*/
/*= mode panel: the buttons that creates multi-line (TobjLine) objects =*/
/*=   - opened multi-line                                              =*/
/*=   - closed multi-line (polygon)                                    =*/
/*======================================================================*/

#include "modepanel.h"
#include "vgui/vgui-efsm-points.h"
#include "fig/obj-line.h"

/*======================================================================*/
/*= Interface                                                          =*/

static void mp_line_create(Tvgui_efsm* a);

static Twid_mousefun3S mp_line_mess[] = {
        { "First point"   , "Freehand"     , 0 },       // BEGIN
        { 0               , 0              , 0 },       // END
        { "Next point"    , "Final point"  , "Cancel"}, // NewPos
        { "Next point"    , "Final point"  , "Cancel"}, // TmpPos
        { "Final point"   , "Final point"  , "Cancel"}, // FreeHand
};

extern void mp_lineclosed_cb(Tvgui_mw* vmw, int uid, void* ud)
{
    Tyfig_mw*      ymw  = (Tyfig_mw*)vmw;
    Tvgui_efsm**   ret  = (Tvgui_efsm**)ud;

    Tvgui_efsmPTS* fsm = vgui_efsmPTS_new_NorMore(3,
			ymw->ymw_canvas, mp_line_create, NULL, ymw);
    fsm->any.magnet = 1;
	fsm->iflag1           = FIGOLI_T_Polygon;
    fsm->skeletonMode     = 2;
    fsm->skeletonGcd      = OD_GC_Preview;
    vgui_efsm_mousefun_enable(&fsm->any,
            ymw->ymw_mouseFun, mp_line_mess);

    yfig_dpp_showonly(ymw,DPP_SHOW_StdLineFillNA);
    *ret = &fsm->any;
}

extern void mp_lineopen_cb(Tvgui_mw* vmw, int uid, void* ud)
{
    Tyfig_mw*      ymw  = (Tyfig_mw*)vmw;
    Tvgui_efsm**   ret  = (Tvgui_efsm**)ud;

    Tvgui_efsmPTS* fsm = vgui_efsmPTS_new_NorMore(2,
			ymw->ymw_canvas, mp_line_create, NULL, ymw);
    fsm->any.magnet = 1;
	fsm->iflag1           = FIGOLI_T_MLine;
    fsm->skeletonMode     = 1;
    fsm->skeletonGcd      = OD_GC_Preview;
    vgui_efsm_mousefun_enable(&fsm->any,
            ymw->ymw_mouseFun, mp_line_mess);

    yfig_dpp_showonly(ymw,DPP_SHOW_StdLineFillWA);
    *ret = &fsm->any;
}

/*======================================================================*/
/*= Private utilities                                                  =*/

static void  mp_line_create(Tvgui_efsm* a)
{
    Tvgui_efsmPTS* fsm = (Tvgui_efsmPTS*)a;
	Tyfig_device*  dev = (Tyfig_device*) a->outdevice;
    Tyfig_mw*      ymw = (Tyfig_mw*)     a->userdata;

    TobjAll obj = obj_line_newA(&ymw->ymw_currDP,
            fsm->iflag1, dble2set_newClone(fsm->points));
    yfig_cursce_addObjWHis(ymw,obj);
    yfig_cursce_redraw_objAdded(ymw,obj);
}

/*======================================================================*/
/*= Icons                                                              =*/

CUstr mp_lineclosed_big[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,
0x7f,0x00,0x00,0x00,0x01,0x80,0x00,0x00,0x00,0x01,0x00,
0x01,0x00,0x00,0x01,0x00,0x02,0x00,0x00,0x01,0x00,0x04,
0x00,0x00,0x01,0x00,0x08,0x00,0x00,0x01,0x00,0x08,0x00,
0x00,0x01,0x00,0x08,0x00,0x00,0x01,0x00,0x08,0x00,0x00,
0x01,0x00,0x08,0x00,0x00,0x01,0x00,0x04,0x00,0x00,0x01,
0x00,0x02,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x01,0x80,
0x00,0x00,0x00,0x01,0x7f,0x00,0x00,0x00,0x01,0x01,0x00,
0x00,0x00,0x01,0x01,0x00,0x00,0x00,0x01,0x01,0x00,0x00,
0x00,0x01,0x01,0x00,0x00,0x00,0x01,0x01,0x00,0x00,0x00,
0x01,0x01,0x00,0x00,0x00,0x01,0x01,0x00,0x00,0x00,0x01,
0x01,0x00,0x00,0x00,0xff,0x01,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

CUstr mp_lineclosed_small[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0x3f,0x00,
0x10,0x40,0x00,0x10,0x80,0x00,0x10,0x00,0x01,0x10,0x00,0x01,
0x10,0x00,0x01,0x10,0x80,0x00,0x10,0x40,0x00,0x10,0x3e,0x00,
0x10,0x02,0x00,0x10,0x02,0x00,0x10,0x02,0x00,0x10,0x02,0x00,
0x10,0x02,0x00,0x10,0x02,0x00,0xf0,0x03,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

/*= == == == == == == == == == == ==  == == == == == == == == == == == =*/

CUstr mp_lineopen_big[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x20,0x00,0x04,0x00,0x00,0x30,0x00,
0x0c,0x00,0x00,0x50,0x00,0x0c,0x00,0x00,0x48,0x00,0x14,
0x00,0x00,0x88,0x00,0x14,0x00,0x00,0x84,0x00,0x14,0x00,
0x00,0x04,0x01,0x22,0x00,0x00,0x02,0x01,0x22,0x00,0x00,
0x02,0x02,0x22,0x00,0x00,0x01,0x02,0x42,0x00,0x00,0x01,
0x04,0x42,0x00,0x80,0x00,0x04,0x42,0x00,0x80,0x00,0x02,
0x01,0x00,0x40,0x00,0x01,0x01,0x00,0x40,0x80,0x00,0x01,
0x00,0x20,0x40,0x00,0x01,0x00,0x20,0x20,0x00,0x01,0x00,
0x00,0x10,0x00,0x01,0x00,0x00,0x08,0x80,0x00,0x00,0x00,
0x30,0x40,0x00,0x00,0x00,0xc0,0x20,0x00,0x00,0x00,0x00,
0x13,0x00,0x00,0x00,0x00,0x0c,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};    

CUstr mp_lineopen_small[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x04,
0x80,0x00,0x04,0x40,0x01,0x04,0x40,0x01,0x02,0x20,0x01,0x02,
0x20,0x02,0x02,0x20,0x02,0x02,0x10,0x04,0x02,0x10,0x04,0x01,
0x08,0x04,0x01,0x08,0x08,0x01,0x00,0x08,0x01,0x00,0x04,0x01,
0x00,0x84,0x01,0x00,0x7a,0x00,0x00,0x06,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

/*======================================================================*/
