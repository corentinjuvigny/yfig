/*======================================================================
 *  Copyright 2017 Ivan Aug√©
 *
 *  This file is part of the YFIG software.
 * 
 *  YFIG is free  software;  you  can redistribute it and/or modify it
 *  under the terms of the GNU  General Public License as published by
 *  the  Free Software Foundation; either version 3 of the License, or
 *  (at your option) any later version.
 * 
 *  YFIG software is distributed  in the  hope that it will be useful,
 *  but WITHOUT ANY WARRANTY;  without even the  implied  warranty  of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See  the GNU
 *  General Public License for more details.
 * 
 *  You should have received  a copy of the GNU General Public License
 *  along with YFIG. If not, see <http://www.gnu.org/licenses/>.
**======================================================================
 *$Software: YFIG-MP (Mode Panel)
 *      $Id: spline.c 120 2018-01-28 16:19:13Z ia $
 * $HeadURL: http://lunix120.ensiie.fr/yfig/trunk/yfig/common/modepanel/spline.c $
 *  $Author: Ivan Auge (Email: auge@ensiie.fr)
**======================================================================*/

/*======================================================================*/
/*= Mode panel FSM for creating spline curves.                         =*/
/*======================================================================*/

#include "modepanel.h"
#include "vgui/vgui-efsm-points.h"
#include "fig/obj-spline.h"
#include "tools/geo2d.h"

/*======================================================================*/
/*= Interface                                                          =*/

static void mp_spline_create(Tvgui_efsm* a);
static void mp_spline_preview(Tvgui_efsmPTS*a, int click1, Cdble2* pts, int ptNb);

static Twid_mousefun3S mp_spline_mess[] = {
        { "First point"   , "Freehand"     , 0 },       // BEGIN
        { 0               , 0              , 0 },       // END
        { "Next point"    , "Final point"  , "Cancel"}, // NewPos
        { "Next point"    , "Final point"  , "Cancel"}, // TmpPos
        { "Final point"   , "Final point"  , "Cancel"}, // FreeHand
};

extern void mp_splineclosed_cb(Tvgui_mw* vmw, int uid, void* ud)
{
    Tyfig_mw*      ymw  = (Tyfig_mw*)vmw;
    Tvgui_efsm**   ret  = (Tvgui_efsm**)ud;

    Tvgui_efsmPTS* fsm = vgui_efsmPTS_new_NorMore(3,
			ymw->ymw_canvas, mp_spline_create, mp_spline_preview, ymw);
    fsm->any.magnet = 1;
	fsm->iflag1           = FIGOSP_T_ClosedApprox;
    fsm->skeletonMode     = 2;
    vgui_efsm_mousefun_enable(&fsm->any,
            ymw->ymw_mouseFun, mp_spline_mess);

    yfig_dpp_showonly(ymw,DPP_SHOW_StdLineFillNA);
    *ret = &fsm->any;
}

extern void mp_splineopen_cb(Tvgui_mw* vmw, int uid, void* ud)
{
    Tyfig_mw*      ymw  = (Tyfig_mw*)vmw;
    Tvgui_efsm**   ret  = (Tvgui_efsm**)ud;

    Tvgui_efsmPTS* fsm = vgui_efsmPTS_new_NorMore(2,
			ymw->ymw_canvas, mp_spline_create, mp_spline_preview, ymw);
    fsm->any.magnet = 1;
	fsm->iflag1           = FIGOSP_T_OpenApprox;
    fsm->skeletonMode     = 1;
    vgui_efsm_mousefun_enable(&fsm->any,
            ymw->ymw_mouseFun, mp_spline_mess);

    yfig_dpp_showonly(ymw,DPP_SHOW_StdLineFillWA);
    *ret = &fsm->any;
}

extern void mp_splineclosedInt_cb(Tvgui_mw* vmw, int uid, void* ud)
{
    Tyfig_mw*      ymw  = (Tyfig_mw*)vmw;
    Tvgui_efsm**   ret  = (Tvgui_efsm**)ud;

    Tvgui_efsmPTS* fsm = vgui_efsmPTS_new_NorMore(3,
			ymw->ymw_canvas, mp_spline_create, mp_spline_preview, ymw);
    fsm->any.magnet = 1;
	fsm->iflag1           = FIGOSP_T_ClosedInterp;
    fsm->skeletonMode     = 2;
    vgui_efsm_mousefun_enable(&fsm->any,
            ymw->ymw_mouseFun, mp_spline_mess);

    yfig_dpp_showonly(ymw,DPP_SHOW_StdLineFillNA);
    *ret = &fsm->any;
}

extern void mp_splineopenInt_cb(Tvgui_mw* vmw, int uid, void* ud)
{
    Tyfig_mw*      ymw  = (Tyfig_mw*)vmw;
    Tvgui_efsm**   ret  = (Tvgui_efsm**)ud;

    Tvgui_efsmPTS* fsm = vgui_efsmPTS_new_NorMore(2,
			ymw->ymw_canvas, mp_spline_create, mp_spline_preview, ymw);
    fsm->any.magnet = 1;
	fsm->iflag1           = FIGOSP_T_OpenInterp;
    fsm->skeletonMode     = 1;
    vgui_efsm_mousefun_enable(&fsm->any,
            ymw->ymw_mouseFun, mp_spline_mess);

    yfig_dpp_showonly(ymw,DPP_SHOW_StdLineFillWA);
    *ret = &fsm->any;
}

/*======================================================================*/
/*= Private utilities                                                  =*/

static void  mp_spline_create(Tvgui_efsm* a)
{
    Tvgui_efsmPTS* fsm = (Tvgui_efsmPTS*)a;
	Tyfig_device*  dev = (Tyfig_device*) a->outdevice;
    Tyfig_mw*      ymw = (Tyfig_mw*)     a->userdata;

#if 0
    int i;
    printf("%s: nb=%d\n",__func__, fsm->points->eleNb);
    for (i=0; i<fsm->points->eleNb ; i+=1) {
      Tdble2* p = fsm->points->eles+i;
      printf("%s: %d/%d x=%f y=%f\n",__func__, i,
              fsm->points->eleNb,p->x,p->y);
    }
#endif

    TobjAll obj = obj_spline_newA(&ymw->ymw_currDP,
            fsm->iflag1, dble2set_newClone(fsm->points));
    yfig_cursce_addObjWHis(ymw,obj);
    yfig_cursce_redraw_objAdded(ymw,obj);
}

static void mp_spline_preview(Tvgui_efsmPTS*fsm, int click1, Cdble2* pts, int ptNb)
{
	TobjAll obj;
	Tyfig_device*  dev = (Tyfig_device*) fsm->any.outdevice;
    Tyfig_mw*      ymw = (Tyfig_mw*)     fsm->any.userdata;

	double angle = 0.0;
    switch ( fsm->iflag1 ) {
      case FIGOSP_T_OpenApprox: case FIGOSP_T_OpenInterp: // case T_OPEN_XSPLINE:
        if ( fsm->points->eleNb>=2 ) goto draw_spline;
        break;
      case FIGOSP_T_ClosedApprox: case FIGOSP_T_ClosedInterp: // case T_CLOSED_XSPLINE:
        if ( fsm->points->eleNb>=3 ) goto draw_spline;
        break;
    }
    // Not enough point to draw a spline, we can just draw a line.
    // But the efsmPTS draws it already, so nothing to do
    return;
draw_spline:
	obj = obj_spline_newA(&ymw->ymw_currDP, fsm->iflag1,
                          dble2set_newClone(fsm->points));
	ydev_draw_obj(dev,obj.any,OD_GC_Preview);
	obj_dir_delObjQ( obj );
    return;
}

/*======================================================================*/
/*= Icons                                                              =*/

CUstr mp_splineclosed_big[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xe0,
0x1f,0x00,0x00,0x00,0x1c,0x60,0x00,0x00,0x00,0x02,0x80,
0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x01,0x00,0x01,
0x00,0x00,0x01,0x80,0x00,0x00,0x00,0x01,0x40,0x00,0x00,
0x00,0x02,0x30,0x00,0x00,0x00,0x3c,0x0c,0x00,0x00,0x00,
0xc0,0x7f,0x00,0x00,0x00,0x30,0x80,0x07,0x00,0x00,0x0c,
0x00,0x08,0x00,0x00,0x03,0x00,0x10,0x00,0x80,0x00,0x00,
0x20,0x00,0x40,0x00,0x00,0x20,0x00,0x40,0x00,0x00,0x20,
0x00,0x20,0x00,0x00,0x20,0x00,0x20,0x00,0x00,0x20,0x00,
0x20,0x00,0x00,0x10,0x00,0x40,0x00,0x00,0x08,0x00,0x40,
0x00,0x00,0x04,0x00,0x80,0x00,0x00,0x03,0x00,0x00,0x07,
0xf0,0x00,0x00,0x00,0xf8,0x0f,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

CUstr mp_splineclosed_small[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x0f,0x00,
0x20,0x10,0x00,0x10,0x20,0x00,0x10,0x20,0x00,0x20,0x18,0x00,
0x40,0x06,0x00,0x80,0x01,0x00,0x60,0x3e,0x00,0x10,0xc0,0x00,
0x08,0x00,0x01,0x08,0x00,0x02,0x08,0x00,0x02,0x08,0x00,0x02,
0x08,0x00,0x01,0x10,0xe0,0x00,0xe0,0x1f,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

/*= == == == == == == == == == == ==  == == == == == == == == == == == =*/

CUstr mp_splineopen_big[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,
0x0f,0x00,0x00,0x00,0x0e,0x70,0x00,0x00,0x00,0x01,0x80,
0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,
0x00,0x80,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,
0x00,0x01,0x00,0x00,0x00,0x00,0x1e,0x00,0x00,0x00,0x00,
0xe0,0x3f,0x00,0x00,0x00,0x00,0xc0,0x03,0x00,0x00,0x00,
0x00,0x04,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x00,
0x10,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x10,
0x00,0x80,0x00,0x00,0x10,0x00,0x80,0x00,0x00,0x08,0x00,
0x00,0x01,0x00,0x04,0x00,0x00,0x01,0x00,0x02,0x00,0x00,
0x02,0x80,0x01,0x00,0x00,0x1c,0x78,0x00,0x00,0x00,0xe0,
0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

CUstr mp_splineopen_small[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x0f,0x00,
0x20,0x10,0x00,0x10,0x20,0x00,0x10,0x00,0x00,0x20,0x00,0x00,
0x40,0x00,0x00,0x80,0x01,0x00,0x00,0x3e,0x00,0x00,0xc0,0x00,
0x00,0x00,0x01,0x00,0x00,0x02,0x00,0x00,0x02,0x00,0x00,0x02,
0x00,0x00,0x03,0x10,0xe0,0x00,0xe0,0x1f,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

/*= == == == == == == == == == == ==  == == == == == == == == == == == =*/

CUstr mp_splineclosedInt_big[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x80,0x03,0x00,0x00,0x00,0xe0,
0x1f,0x00,0x00,0x00,0x9c,0x63,0x00,0x00,0x00,0x02,0xc0,
0x01,0x00,0x80,0x03,0xc0,0x01,0x00,0x80,0x03,0xc0,0x01,
0x00,0x80,0x03,0x80,0x00,0x00,0x00,0x01,0x40,0x00,0x00,
0x00,0x02,0x30,0x00,0x00,0x00,0x3c,0x1c,0x00,0x00,0x00,
0xc0,0x7f,0x00,0x00,0x00,0x30,0x9c,0x07,0x00,0x00,0x0c,
0x00,0x08,0x00,0x00,0x03,0x00,0x10,0x00,0x80,0x00,0x00,
0x20,0x00,0x40,0x00,0x00,0x70,0x00,0x40,0x00,0x00,0x70,
0x00,0xe0,0x00,0x00,0x70,0x00,0xe0,0x00,0x00,0x20,0x00,
0xe0,0x00,0x00,0x10,0x00,0x40,0x00,0x00,0x08,0x00,0x40,
0x00,0x00,0x04,0x00,0x80,0x00,0x00,0x03,0x00,0x00,0xc7,
0xf1,0x00,0x00,0x00,0xf8,0x0f,0x00,0x00,0x00,0xc0,0x01,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

CUstr mp_splineclosedInt_small[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x10,0x00,
0xc0,0x1f,0x00,0xa0,0x18,0x00,0x10,0x20,0x00,0x10,0x24,0x00,
0x20,0x1c,0x00,0x40,0x0e,0x00,0x80,0x41,0x00,0x68,0x7e,0x00,
0x18,0xe0,0x00,0x18,0x00,0x01,0x08,0x00,0x02,0x08,0x00,0x02,
0x08,0x00,0x03,0x28,0x10,0x07,0x30,0xf0,0x00,0xf0,0x3f,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

/*= == == == == == == == == == == ==  == == == == == == == == == == == =*/

CUstr mp_splineopenInt_big[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x00,0x00,0x00,0xe0,
0x1f,0x00,0x00,0x00,0x1c,0xe7,0x03,0x00,0x00,0x02,0x80,
0x03,0x00,0x00,0x01,0x80,0x03,0x00,0x80,0x03,0x00,0x00,
0x00,0x80,0x03,0x00,0x00,0x00,0x80,0x03,0x00,0x00,0x00,
0x00,0x02,0x00,0x00,0x00,0x00,0x3c,0x0e,0x00,0x00,0x00,
0xc0,0x7f,0x00,0x00,0x00,0x00,0x8e,0x07,0x00,0x00,0x00,
0x00,0x08,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,
0x20,0x00,0x00,0x00,0x00,0x70,0x00,0x00,0x00,0x00,0x70,
0x00,0xe0,0x00,0x00,0x70,0x00,0xe0,0x00,0x00,0x20,0x00,
0xe0,0x00,0x00,0x10,0x00,0x80,0x00,0x00,0x0c,0x00,0x00,
0x01,0x00,0x03,0x00,0x00,0x8e,0xe3,0x00,0x00,0x00,0xf0,
0x1f,0x00,0x00,0x00,0x80,0x03,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

CUstr mp_splineopenInt_small[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0xc0,0x1f,0x00,
0xe0,0x30,0x00,0x10,0x30,0x00,0x10,0x00,0x00,0x20,0x00,0x00,
0x40,0x00,0x00,0x80,0x01,0x00,0x00,0x7e,0x00,0x00,0xe0,0x00,
0x00,0x60,0x01,0x00,0x00,0x02,0x00,0x00,0x02,0x00,0x00,0x07,
0x00,0x00,0x07,0x30,0xf0,0x00,0xf0,0x3f,0x00,0x30,0x30,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

/*======================================================================*/
