/*======================================================================
 *  Copyright 2017 Ivan Aug√©
 *
 *  This file is part of the YFIG software.
 * 
 *  YFIG is free  software;  you  can redistribute it and/or modify it
 *  under the terms of the GNU  General Public License as published by
 *  the  Free Software Foundation; either version 3 of the License, or
 *  (at your option) any later version.
 * 
 *  YFIG software is distributed  in the  hope that it will be useful,
 *  but WITHOUT ANY WARRANTY;  without even the  implied  warranty  of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See  the GNU
 *  General Public License for more details.
 * 
 *  You should have received  a copy of the GNU General Public License
 *  along with YFIG. If not, see <http://www.gnu.org/licenses/>.
**======================================================================
 *$Software: YFIG-MP (Mode Panel)
 *      $Id: ellipse.c 353 2018-11-11 22:56:57Z ia $
 * $HeadURL: http://lunix120.ensiie.fr/yfig/trunk/yfig/common/modepanel/ellipse.c $
 *  $Author: Ivan Auge (Email: auge@ensiie.fr)
**======================================================================*/

/*======================================================================*/
/*= Mode panel FSM for creating ellipses curves.                       =*/
/*======================================================================*/

#include "modepanel.h"
#include "vgui/vgui-efsm-points.h"
#include "fig/obj-ellipse.h"

/*======================================================================*/
/*= Interface                                                          =*/

static void mp_ell_create (Tvgui_efsm* a);
static void mp_ell_preview(Tvgui_efsmPTS*a, int click1, Cdble2* pts, int ptNb);

static  Twid_mousefun3S mp_ellrad_mess[] = {
    { "Circle center" , "Ellipse center", 0 },       // BEGIN
    { 0               , 0               , 0 },       // END
    { "Set radius"    , "Set radius"    , "Cancel"}, // NewPos
    { "Set radius"    , "Set radius"    , "Cancel"}, // TmpPos
    { 0               , 0               , 0 },       // HandFree
};

extern void mp_ellrad_cb(Tvgui_mw* vmw, int uid, void* ud)
{
    Tyfig_mw*      ymw  = (Tyfig_mw*)vmw;
    Tvgui_efsm**   ret  = (Tvgui_efsm**)ud;

    Tvgui_efsmPTS* fsm = vgui_efsmPTS_new_Nexact(
            2, ymw->ymw_canvas,
            mp_ell_create, mp_ell_preview, ymw);
    fsm->any.magnet = 1;
    fsm->iflag1 = FIGOELL_T_EllByRad;
    fsm->skeletonMode     = 1;
    vgui_efsm_mousefun_enable(&fsm->any,
            ymw->ymw_mouseFun, mp_ellrad_mess);

    yfig_dpp_showonly(ymw,DPP_SHOW_Angle|DPP_SHOW_StdCurveFillNA);
    *ret = &fsm->any;
}

static  Twid_mousefun3S mp_elldia_mess[] = {
    { "Circle diameter" , "Ellipse diameter", 0 },       // BEGIN
    { 0                 , 0                 , 0 },       // END
    { "Final corner"    , "Final corner"    , "Cancel"}, // NewPos
    { "Final corner"    , "Final corner"    , "Cancel"}, // TmpPos
    { 0                 , 0                 , 0 },       // FreeHand
};

extern void mp_elldia_cb(Tvgui_mw* vmw, int uid, void* ud)

{
    Tyfig_mw*      ymw  = (Tyfig_mw*)vmw;
    Tvgui_efsm**   ret  = (Tvgui_efsm**)ud;

    Tvgui_efsmPTS* fsm = vgui_efsmPTS_new_Nexact(
            2, ymw->ymw_canvas,
            mp_ell_create, mp_ell_preview, ymw);
    fsm->any.magnet = 1;
    fsm->iflag1 = FIGOELL_T_EllByDia;
    fsm->skeletonMode     = 1;
    vgui_efsm_mousefun_enable(&fsm->any,
            ymw->ymw_mouseFun, mp_elldia_mess);

    yfig_dpp_showonly(ymw,DPP_SHOW_Angle|DPP_SHOW_StdCurveFillNA);
    *ret = &fsm->any;
}

/*======================================================================*/
/*= Private utilities                                                  =*/

static void  mp_ell_create(Tvgui_efsm* a)
{
    Tvgui_efsmPTS* fsm   = (Tvgui_efsmPTS*)a;
    Tyfig_device*  ydev  = (Tyfig_device*) a->outdevice;
    Tyfig_mw*      ymw   = (Tyfig_mw*)     a->userdata;
    double         angle = yfig_mw_getAngleRad(ymw);
printf("ANGLE=%.2f\n",angle);

    TobjAll obj = obj_ellipse_newA(&ymw->ymw_currDP,
      fsm->iflag1==FIGOELL_T_EllByRad && fsm->firstClick==2 ?   FIGOELL_T_EllByRad :
      fsm->iflag1==FIGOELL_T_EllByRad && fsm->firstClick==1 ?   FIGOELL_T_CirByRad :
      fsm->iflag1==FIGOELL_T_EllByDia && fsm->firstClick==2 ?   FIGOELL_T_EllByDia :
    /*fsm->iflag1==FIGOELL_T_EllByDia && fsm->firstClick==1 ?*/ FIGOELL_T_CirByDia,
      fsm->points->eles[0],fsm->points->eles[1],angle
    );
    yfig_cursce_addObjWHis(ymw,obj);
    yfig_cursce_redraw_objAdded(ymw,obj);
}

static void mp_ell_preview (Tvgui_efsmPTS*a, int click1, Cdble2*pts, int ptNb)
{
    Tvgui_efsmPTS* fsm = (Tvgui_efsmPTS*)a;
    Tyfig_device*  dev = (Tyfig_device*) a->any.outdevice;
    Tyfig_mw*      ymw = (Tyfig_mw*)     a->any.userdata;
    double         angle = yfig_mw_getAngleRad(ymw);

    TEMP_asf_printf(ptNb!=2,"ptNb is %d instead of 2",ptNb);

    TobjAll obj = obj_ellipse_newA(&ymw->ymw_currDP,
      fsm->iflag1==FIGOELL_T_EllByRad && fsm->firstClick==2 ?   FIGOELL_T_EllByRad :
      fsm->iflag1==FIGOELL_T_EllByRad && fsm->firstClick==1 ?   FIGOELL_T_CirByRad :
      fsm->iflag1==FIGOELL_T_EllByDia && fsm->firstClick==2 ?   FIGOELL_T_EllByDia :
    /*fsm->iflag1==FIGOELL_T_EllByDia && fsm->firstClick==1 ?*/ FIGOELL_T_CirByDia,
      pts[0],pts[1],angle
    );

    ydev_draw_obj(dev,obj.any,OD_GC_Preview);
    obj_dir_delObjQ( obj );
}

/*======================================================================*/
/*= Icons                                                              =*/

CUstr mp_ellrad_big[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x3f,0x00,0x00,0x00,
0x70,0xc4,0x01,0x00,0x00,0x0c,0x00,0x06,0x00,0x00,0x02,0x04,
0x08,0x00,0x00,0x01,0x00,0x10,0x00,0x80,0x00,0x04,0x20,0x00,
0x40,0x00,0x00,0x40,0x00,0x40,0x00,0x04,0x40,0x00,0x20,0x00,
0x04,0x80,0x00,0x20,0x00,0x5f,0xd5,0x00,0x20,0x00,0x04,0x80,
0x00,0x40,0x00,0x04,0x40,0x00,0x40,0x00,0x00,0x40,0x00,0x80,
0x00,0x00,0x20,0x00,0x00,0x01,0x00,0x10,0x00,0x00,0x02,0x00,
0x08,0x00,0x00,0x0c,0x00,0x06,0x00,0x00,0x70,0xc0,0x01,0x00,
0x00,0x80,0x3f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,};

CUstr mp_ellrad_small[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x1f,0x00,0xe0,0xe0,0x00,0x10,0x00,0x01,
0x08,0x00,0x02,0x08,0x00,0x02,0x04,0x04,0x04,0x04,0xae,0x06,
0x04,0x04,0x04,0x08,0x00,0x02,0x08,0x00,0x02,0x10,0x00,0x01,
0xe0,0xe0,0x00,0x00,0x1f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

/*=  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =*/

CUstr mp_elldia_big[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x3f,0x00,0x00,0x00,
0x70,0xc4,0x01,0x00,0x00,0x0c,0x00,0x06,0x00,0x00,0x02,0x04,
0x08,0x00,0x00,0x01,0x00,0x10,0x00,0x80,0x00,0x04,0x20,0x00,
0x40,0x00,0x00,0x40,0x00,0x40,0x00,0x04,0x40,0x00,0x20,0x00,
0x04,0x80,0x00,0x60,0x55,0x5f,0xd5,0x00,0x20,0x00,0x04,0x80,
0x00,0x40,0x00,0x04,0x40,0x00,0x40,0x00,0x00,0x40,0x00,0x80,
0x00,0x04,0x20,0x00,0x00,0x01,0x00,0x10,0x00,0x00,0x02,0x04,
0x08,0x00,0x00,0x0c,0x00,0x06,0x00,0x00,0x70,0xc4,0x01,0x00,
0x00,0x80,0x3f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,};

CUstr mp_elldia_small[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x1f,0x00,0xe0,0xe0,0x00,0x10,0x00,0x01,
0x08,0x00,0x02,0x08,0x00,0x02,0x04,0x04,0x04,0xac,0xae,0x06,
0x04,0x04,0x04,0x08,0x00,0x02,0x08,0x00,0x02,0x10,0x00,0x01,
0xe0,0xe0,0x00,0x00,0x1f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

/*======================================================================*/
