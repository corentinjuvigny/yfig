/*======================================================================
 *  Copyright 2017 Ivan Aug√©
 *
 *  This file is part of the YFIG software.
 * 
 *  YFIG is free  software;  you  can redistribute it and/or modify it
 *  under the terms of the GNU  General Public License as published by
 *  the  Free Software Foundation; either version 3 of the License, or
 *  (at your option) any later version.
 * 
 *  YFIG software is distributed  in the  hope that it will be useful,
 *  but WITHOUT ANY WARRANTY;  without even the  implied  warranty  of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See  the GNU
 *  General Public License for more details.
 * 
 *  You should have received  a copy of the GNU General Public License
 *  along with YFIG. If not, see <http://www.gnu.org/licenses/>.
**======================================================================
 *$Software: YFIG-MP (Mode Panel)
 *      $Id: rect-hv.c 353 2018-11-11 22:56:57Z ia $
 * $HeadURL: http://lunix120.ensiie.fr/yfig/trunk/yfig/common/modepanel/rect-hv.c $
 *  $Author: Ivan Auge (Email: auge@ensiie.fr)
**======================================================================*/

/*======================================================================*/
/*= Mode panel FSM for creating ellipses curves.                       =*/
/*======================================================================*/

#include "modepanel.h"
#include "vgui/vgui-efsm-points.h"
#include "vgui/wid-buttonPanel.h"
#include "fig/obj-ellipse.h"
#include "outdev/ldaf-hl.h"

// for image
#include "vgui/vgui-dw.h"
#include "vgui/wid-filebrowser.h"
#include "tools/bitmap.h"
#include "tools/imgfmt.h"

#define ENTRY(entry,id,create,preview,mFun)            \
extern void entry(Tvgui_mw* vmw, int uid, void* ud) {  \
    Tyfig_mw*      ymw  = (Tyfig_mw*)vmw;              \
    Tvgui_efsm**   ret  = (Tvgui_efsm**)ud;            \
                                                       \
    Tvgui_efsmPTS* fsm = vgui_efsmPTS_new_Nexact(      \
            2, ymw->ymw_canvas, create, preview, ymw); \
    fsm->any.magnet = 1; fsm->iflag1 = id; fsm->skeletonMode = 1;  \
    vgui_efsm_mousefun_enable(&fsm->any, ymw->ymw_mouseFun, mFun); \
                                                       \
    yfig_dpp_showonly(ymw,DPP_SHOW_StdCurveFillNA);    \
    *ret = &fsm->any; }

/*======================================================================*/
/*= Interface                                                          =*/

static void mp_sqrrect_create (Tvgui_efsm* a);
static void mp_sqrrect_preview(Tvgui_efsmPTS*a, int click1, Cdble2* pts, int ptNb);

static  Twid_mousefun3S mp_sqrrect_mess[] = {
    { "1st corner point"  , "1st corner point" , 0 },       // BEGIN
    { 0                   , 0                  , 0 },       // END
    { "2nd corner point"  , "2nd corner point" , "Cancel"}, // NewPos
    { "2nd corner point"  , "2nd corner point" , "Cancel"}, // TmpPos
    { 0                   , 0                  , 0 },  
};

ENTRY(mp_sqrrect_cb,1,mp_sqrrect_create,mp_sqrrect_preview,mp_sqrrect_mess)
ENTRY(mp_arcrect_cb,2,mp_sqrrect_create,mp_sqrrect_preview,mp_sqrrect_mess)
ENTRY(mp_image_cb  ,3,mp_sqrrect_create,mp_sqrrect_preview,mp_sqrrect_mess)

/*======================================================================*/
/*= Private utilities                                                  =*/

// starts and runs a modal dialog to get an image file.
// Return:
//   NULL: user cancelled the dialog
//   otherwise: a pointer to a valid file path. The caller must free it
//              after use.
static TstrEaten ydw_getImageFile(Tyfig_mw* ymw);

static void  mp_sqrrect_create(Tvgui_efsm* a)
{
    Tvgui_efsmPTS* fsm   = (Tvgui_efsmPTS*)a;
    Tyfig_device*  fsod  = (Tyfig_device*) a->outdevice;
    Tyfig_mw*      ymw   = (Tyfig_mw*)     a->userdata;
    Tdble2*        pts   = fsm->points->eles;
//  double         angle = yfig_mw_getAngle(ymw);

    TobjAll obj;
    if ( fsm->iflag1==1 ) 
        obj = obj_sqrrect_newAPTPT(&ymw->ymw_currDP,pts[0],pts[1]);
    else if ( fsm->iflag1==2 ) 
        obj = obj_arcrect_newAPTPT(&ymw->ymw_currDP,pts[0],pts[1]);
    else {
        TstrEaten file = ydw_getImageFile(ymw);
        if ( file==NULL ) return;
        obj = obj_image_newAbyPTPT(&ymw->ymw_currDP, pts[0],pts[1], image_new(file,IMG_OP_NoOpe));
        tool_free(file);
    }
    yfig_cursce_addObjWHis(ymw,obj);
    yfig_cursce_redraw_objAdded(ymw,obj);
}

static void mp_sqrrect_preview (Tvgui_efsmPTS*a, int click1, Cdble2*pts, int ptNb)
{
    Tvgui_efsmPTS* fsm   = (Tvgui_efsmPTS*)a;
    Tyfig_device*  fsod  = (Tyfig_device*) a->any.outdevice;
    Tyfig_mw*      ymw   = (Tyfig_mw*)     a->any.userdata;
//    double         angle = yfig_mw_getAngle(ymw);

    TEMP_asf_printf(ptNb!=2,"ptNb is %d instead of 2",ptNb);

    char tmp1[100],tmp2[100];
    CuserUnit* usrunit = &ymw->ymw_userUnit;
    double     srcppi  = fsod_getPpiSrc(fsod);
    double     dx      = abs(pts[0].x-pts[1].x);
    double     dy      = abs(pts[0].y-pts[1].y);
    yfig_mw_usridt_printf(ymw, 
            "Width = %s, Height = %s, Width/Height %.*f",
            lu_LenPpiToUsrStr(usrunit,dx,srcppi,tmp1),
            lu_LenPpiToUsrStr(usrunit,dy,srcppi,tmp2),
            dx/dy, (dx/dy)<1 ? 3 : 1);

    TboxDble bb; tool_boxDble_initPT(&bb,pts[0],pts[1]);
    od_draw_rectBB( fsod_getOD(fsod), OD_GC_Preview,bb);
}

/*======================================================================*/
/*= Dialog to get an image file.                                       =*/

// init. filemaskId, filemask and filemasks from tool image data DB
static void ydw_getImageFile_doFileMask(Twid_filebrowser* fbdata)
{
    int kds[IMGFMT_RasNb];
    int i;

    for (i=0;i<IMGFMT_RasNb ; i+=1) kds[i] = IMGFMT_RasFirst+i;
    vgui_filebrowser_initFileMaskT(fbdata,kds,IMGFMT_RasNb);
}

static TstrEaten ydw_getImageFile(Tyfig_mw* ymw)
{
    Tvgui_dw* self = vgui_dw_newTop(sizeof(*self), &ymw->any, 
                            tool_strdup("Select an image file"),
                            0);
    int i;

    Twid_filebrowser* fbdata;
    fbdata          = wid_filebrowser_new(self ,1,NULL,ymw->ymw_OMSFdir);
    ydw_getImageFile_doFileMask(fbdata);
    wid_filebrowser_dbf(fbdata);
    
    Twid_buttonPanel* button_panel = self->top->dt_ctlButtons;
    if ( !fbdata->embedded ) {
        button_panel->bp_widEGSext = button_panel->bp_widEGSint = gui_buttonPanel_build(button_panel, NULL);
        vgui_dw_addCtlButts(self, 
                            WID_DIALSTATUS_Cancel, "Cancel",
                            WID_DIALSTATUS_Ok,     "Ok",
                            WID_DIALSTATUS_None
                    );

        for (i = 0; i < button_panel->bp_btnNb; i++)
            wid_button_dbf(button_panel->bp_btns[i], NULL);
        gui_buttonPanel_finishR1Cn(button_panel);
    }

#if 1 // IVG FIXME:REMOVE
    if ( fbdata->embedded )
        vgui_dw_finishIC(self, 0,fbdata->widEGS, -1);
    else
        vgui_dw_finishIC(self, 0,fbdata->widEGS, 0, button_panel->bp_widEGSext, -1); 
#else
    if ( fbdata->embedded )
        vgui_dw_finishIC(self, 0,fbdata->widEGSins, -1);
    else
        vgui_dw_finishIC(self, 0,fbdata->widEGSins, 0, button_panel->bp_widEGSext, -1); 
#endif
    self->top->dt_buttsMaskOrg = WID_DIALSTATUS_CancelX|WID_DIALSTATUS_Cancel|WID_DIALSTATUS_Ok;
    int status = vgui_dw_run(self);
    TstrEaten ret = status==WID_DIALSTATUS_Ok ?  vgui_filebrowser_getFilPath(fbdata) : NULL;

    vgui_dw_free(self);
    wid_filebrowser_delete( fbdata );
    return ret;
}

/*======================================================================*/
/*= Icons                                                              =*/

CUstr mp_sqrrect_big[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xff,0xff,0x1f,
0x00,0x80,0x00,0x00,0x10,0x00,0x80,0x00,0x00,0x10,0x00,
0x80,0x00,0x00,0x10,0x00,0x80,0x00,0x00,0x10,0x00,0x80,
0x00,0x00,0x10,0x00,0x80,0x00,0x00,0x10,0x00,0x80,0x00,
0x00,0x10,0x00,0x80,0x00,0x00,0x10,0x00,0x80,0x00,0x00,
0x10,0x00,0x80,0x00,0x00,0x10,0x00,0x80,0x00,0x00,0x10,
0x00,0x80,0x00,0x00,0x10,0x00,0x80,0x00,0x00,0x10,0x00,
0x80,0x00,0x00,0x10,0x00,0x80,0xff,0xff,0x1f,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

CUstr mp_sqrrect_small[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xf8,0xff,0x07,0x08,0x00,0x04,0x08,0x00,0x04,
0x08,0x00,0x04,0x08,0x00,0x04,0x08,0x00,0x04,0x08,0x00,0x04,
0x08,0x00,0x04,0x08,0x00,0x04,0x08,0x00,0x04,0x08,0x00,0x04,
0xf8,0xff,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

/*=  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =*/

CUstr mp_arcrect_big[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xfc,0xff,0x03,0x00,0x00,0x03,0x00,0x0c,
0x00,0x80,0x00,0x00,0x10,0x00,0x80,0x00,0x00,0x10,0x00,
0x40,0x00,0x00,0x20,0x00,0x40,0x00,0x00,0x20,0x00,0x40,
0x00,0x00,0x20,0x00,0x40,0x00,0x00,0x20,0x00,0x40,0x00,
0x00,0x20,0x00,0x40,0x00,0x00,0x20,0x00,0x40,0x00,0x00,
0x20,0x00,0x40,0x00,0x00,0x20,0x00,0x40,0x00,0x00,0x20,
0x00,0x40,0x00,0x00,0x20,0x00,0x80,0x00,0x00,0x10,0x00,
0x80,0x00,0x00,0x10,0x00,0x00,0x03,0x00,0x0c,0x00,0x00,
0xfc,0xff,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

CUstr mp_arcrect_small[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xe0,0xff,0x01,0x10,0x00,0x02,0x08,0x00,0x04,0x08,0x00,0x04,
0x08,0x00,0x04,0x08,0x00,0x04,0x08,0x00,0x04,0x08,0x00,0x04,
0x08,0x00,0x04,0x08,0x00,0x04,0x08,0x00,0x04,0x08,0x00,0x04,
0x10,0x00,0x02,0xe0,0xff,0x01,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

/*=  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =*/

CUstr mp_image_big[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x3e,0x00,0x00,0x00,0x00,0x7f,0x00,
0x00,0xe0,0x9b,0xff,0x3c,0x00,0xe0,0xdb,0xff,0x3d,0x00,0xe0,
0xff,0xff,0x7f,0x00,0x30,0x00,0x00,0xc0,0x00,0xf0,0xff,0xbe,
0xff,0x00,0xf0,0xff,0xff,0xff,0x00,0xf0,0xff,0xc1,0xff,0x00,
0xf0,0xff,0x9c,0xff,0x00,0xf0,0x7f,0x22,0xff,0x00,0xf0,0x7f,
0x41,0xff,0x00,0xf0,0x7f,0x41,0xff,0x00,0xf0,0x7f,0x22,0xff,
0x00,0xf0,0xff,0x9c,0xff,0x00,0xf0,0xff,0xc1,0xff,0x00,0xf0,
0xff,0xff,0xff,0x00,0xf0,0xff,0xff,0xff,0x00,0x00,0x00,0x00,
0x00,0x00,0x78,0x04,0x00,0x00,0x00,0x90,0x00,0x02,0x00,0x00,
0x90,0x66,0x97,0x9a,0x01,0x70,0x14,0x92,0x44,0x01,0x10,0x14,
0x92,0xc4,0x00,0x10,0x14,0x92,0x44,0x00,0x38,0x64,0x64,0x8e,
0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,};

CUstr mp_image_small[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x00,0xc0,0x45,0x00,
0x20,0x42,0x00,0x20,0x7e,0x00,0x20,0x87,0x00,0xc0,0x8f,0x00,
0x20,0xf2,0x00,0x20,0x13,0x00,0xc0,0x12,0x00,0x00,0x0c,0x00,
0x1c,0x00,0x00,0x14,0x02,0x00,0x1c,0x07,0x00,0x84,0x52,0x0b,
0x54,0x52,0x15,0x54,0x52,0x0d,0x94,0x74,0x19,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00};

/*======================================================================*/
