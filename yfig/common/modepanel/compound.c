/*======================================================================
 *  Copyright 2017 Ivan Aug√©
 *
 *  This file is part of the YFIG software.
 * 
 *  YFIG is free  software;  you  can redistribute it and/or modify it
 *  under the terms of the GNU  General Public License as published by
 *  the  Free Software Foundation; either version 3 of the License, or
 *  (at your option) any later version.
 * 
 *  YFIG software is distributed  in the  hope that it will be useful,
 *  but WITHOUT ANY WARRANTY;  without even the  implied  warranty  of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See  the GNU
 *  General Public License for more details.
 * 
 *  You should have received  a copy of the GNU General Public License
 *  along with YFIG. If not, see <http://www.gnu.org/licenses/>.
**======================================================================
 *$Software: YFIG-MP (Mode Panel)
 *      $Id: compound.c 123 2018-04-11 08:28:17Z ia $
 * $HeadURL: http://lunix120.ensiie.fr/yfig/trunk/yfig/common/modepanel/compound.c $
 *  $Author: Ivan Auge (Email: auge@ensiie.fr)
**======================================================================*/

/*======================================================================*/
/*= mode panel: compound object handling (create, delete, enter).      =*/
/*======================================================================*/

#include "modepanel.h"
#include "yfig-efsmSelObj.h"

#include "fig/fig-scene.h"

/*======================================================================*/
/*= Interface                                                          =*/

// create a specialized EFSM that creates compounds.
static Tvgui_efsm* cpdDo_newEFSM( Twid_canvas*cvs, Tyfig_mw*ymw);

// flat the selected obj compound.
static void cpdBreak_do(TefsmSel1Obj*fsm, int click1,
                        TobjAll obj, Tdble2 marker);

// open the selected obj compound.
static void cpdOpen_do(TefsmSel1Obj*fsm, int click,
                       TobjAll obj, Tdble2 marker);

static Twid_mousefun3S mp_cpdDo_mess[] = {
    { "Tag object" , "Tag region"   , "Compound tagged" }, // Begin
    { 0            , 0              , 0                 }, // End
    { 0            , "Final corner" , "Cancel"          }, // REG1
    { 0            , "Final corner" , "Cancel"          }, // REG2
};

extern void mp_cpdDo_cb(Tvgui_mw* vmw, int uid, void* ud)
{
    Tyfig_mw*        ymw  = (Tyfig_mw*)vmw;
    Tvgui_efsm**     ret  = (Tvgui_efsm**)ud;
    Twid_canvas*     cvs  = ymw->ymw_canvas;

    Tvgui_efsm* fsm = cpdDo_newEFSM(cvs,ymw);

    vgui_efsm_mousefun_enable(fsm, ymw->ymw_mouseFun, mp_cpdDo_mess);
    yfig_dpp_showonly(ymw,DPP_SHOW_Zoom);
    *ret = fsm;
}

static Twid_mousefun3S mp_cpdBreak_mess[] = {
    { "Break compound" , "Break compound & Tag"  , 0 }, // BEGIN
    { 0                , 0                       , 0 }, // END
    { 0                , 0                       , 0 }, // OBJSEL
    { 0                , 0                       , 0 }, // OBJNEW
};

extern void mp_cpdBreak_cb(Tvgui_mw* vmw, int uid, void* ud)
{
    Tyfig_mw*        ymw  = (Tyfig_mw*)vmw;
    Tvgui_efsm**     ret  = (Tvgui_efsm**)ud;
    Twid_canvas*     cvs  = ymw->ymw_canvas;

    TefsmSel1Obj*  fsm = yfig_efsmSel1Obj_new(cvs,
            FSC_MM_DIR,cpdBreak_do,ymw);

    vgui_efsm_mousefun_enable(&fsm->any,
            ymw->ymw_mouseFun, mp_cpdBreak_mess);

    yfig_dpp_showonly(ymw,DPP_SHOW_Zoom);
    *ret = &fsm->any;
}

static Twid_mousefun3S mp_cpdOpen_mess[] = {
    { "Open compound" , "Open compound & Keep visible" , 0 },  // BEGIN
    { 0               , 0                              , 0 },  // END
    { 0               , 0                              , 0 }, // OBJSEL
    { 0               , 0                              , 0 }, // OBJNEW
};

extern void mp_cpdOpen_cb(Tvgui_mw* vmw, int uid, void* ud)
{
    Tyfig_mw*        ymw  = (Tyfig_mw*)vmw;
    Tvgui_efsm**     ret  = (Tvgui_efsm**)ud;
    Twid_canvas*     cvs  = ymw->ymw_canvas;

    TefsmSel1Obj*  fsm = yfig_efsmSel1Obj_new(cvs,
            FSC_MM_DIR,cpdOpen_do,ymw);

    vgui_efsm_mousefun_enable(&fsm->any,
            ymw->ymw_mouseFun, mp_cpdOpen_mess);

    yfig_dpp_showonly(ymw,DPP_SHOW_Zoom);
    *ret = &fsm->any;
}

/*======================================================================*/
/* Private utilities                                                   =*/

// EFSM for creating compounds.
#include "compound-do.c"

static void cpdBreak_do(TefsmSel1Obj*fsm, int click1,
                        TobjAll obj, Tdble2 marker)
{
    Tyfig_mw*      ymw = (Tyfig_mw*)     fsm->fsm_userdata;

    yfig_cursce_fltObjWHis(ymw,obj);
    // No redrawing is needed because the picture does not change.
    // Indeed, we just suppress an hierarchical level in the object tree,
    // all the true object are preserved and still stay at the same place.
}

// open and close compounds.
#include "compound-open.c"

/*======================================================================*/
/*= Icons                                                              =*/

CUstr mp_cpdDo_big[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x38,0x00,0x00,0xe0,0x00,0xf8,0xff,
    0xff,0xff,0x00,0x38,0x00,0x00,0xe0,0x00,0x10,0x00,0xe0,
    0x40,0x00,0x10,0x3c,0x18,0x43,0x00,0x10,0x42,0x04,0x44,
    0x00,0x10,0x81,0x04,0x44,0x00,0x10,0x01,0x04,0x44,0x00,
    0x10,0x02,0x18,0x43,0x00,0x10,0x3c,0xe0,0x40,0x00,0x10,
    0x40,0x00,0x40,0x00,0x10,0x80,0x00,0x40,0x00,0x10,0x81,
    0x00,0x41,0x00,0x10,0x42,0x00,0x42,0x00,0x10,0x3c,0x00,
    0x44,0x00,0x10,0x00,0xfe,0x48,0x00,0x10,0x00,0x10,0x48,
    0x00,0x10,0x00,0x10,0x48,0x00,0x10,0xff,0x10,0x48,0x00,
    0x10,0x81,0x10,0x48,0x00,0x10,0x81,0x10,0x44,0x00,0x10,
    0x81,0x10,0x42,0x00,0x10,0xff,0x10,0x41,0x00,0x10,0x00,
    0x00,0x40,0x00,0x38,0x00,0x00,0xe0,0x00,0xf8,0xff,0xff,
    0xff,0x00,0x38,0x00,0x00,0xe0,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00};

CUstr mp_cpdDo_small[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0xfc,0xff,0x0f,0x0c,0x00,0x0c,
    0xe4,0xe0,0x08,0x14,0x11,0x09,0x34,0x08,0x0a,0xc4,0x08,0x0a,
    0x14,0x11,0x09,0xe4,0xe0,0x08,0x04,0x00,0x08,0x04,0x00,0x09,
    0x04,0x7c,0x0a,0xf4,0x11,0x0a,0x14,0x11,0x0a,0x14,0x11,0x0a,
    0xf4,0x11,0x09,0x04,0x90,0x08,0x0c,0x00,0x0c,0xfc,0xff,0x0f,
    0x00,0x00,0x00,0x00,0x00,0x00};

/*=  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =*/

CUstr mp_cpdBreak_big[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x55,
    0x55,0x55,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0xe0,
    0x40,0x00,0x00,0x3c,0x18,0x03,0x00,0x10,0x42,0x04,0x44,
    0x00,0x00,0x81,0x04,0x04,0x00,0x10,0x01,0x04,0x44,0x00,
    0x00,0x02,0x18,0x03,0x00,0x10,0x3c,0xe0,0x40,0x00,0x00,
    0x40,0x00,0x00,0x00,0x10,0x80,0x00,0x40,0x00,0x00,0x81,
    0x00,0x01,0x00,0x10,0x42,0x00,0x42,0x00,0x00,0x3c,0x00,
    0x04,0x00,0x10,0x00,0xfe,0x48,0x00,0x00,0x00,0x10,0x08,
    0x00,0x10,0x00,0x10,0x48,0x00,0x00,0xff,0x10,0x08,0x00,
    0x10,0x81,0x10,0x48,0x00,0x00,0x81,0x10,0x04,0x00,0x10,
    0x81,0x10,0x42,0x00,0x00,0xff,0x10,0x01,0x00,0x10,0x00,
    0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x55,0x55,
    0x55,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00};

CUstr mp_cpdBreak_small[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x54,0x55,0x05,0x00,0x00,0x08,
    0xe4,0xe0,0x00,0x10,0x11,0x09,0x34,0x08,0x02,0xc0,0x08,0x0a,
    0x14,0x11,0x01,0xe0,0xe0,0x08,0x04,0x00,0x00,0x00,0x00,0x09,
    0x04,0x7c,0x02,0xf0,0x11,0x0a,0x14,0x11,0x02,0x10,0x11,0x0a,
    0xf4,0x11,0x01,0x00,0x90,0x08,0x04,0x00,0x00,0xa8,0xaa,0x0a,
    0x00,0x00,0x00,0x00,0x00,0x00};

/*=  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =*/

CUstr mp_cpdOpen_big[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x18,0x00,0x0c,0x00,0x00,0xf8,0xff,0x0f,0x00,0x00,0x10,
    0x00,0x04,0x00,0x00,0x10,0x00,0x04,0x00,0x00,0x90,0x01,0x04,
    0x00,0x00,0x50,0x02,0x04,0x00,0x00,0x50,0x82,0x04,0x00,0x00,
    0x90,0xe1,0x04,0x00,0x00,0x10,0x98,0x04,0x00,0x00,0x10,0x8c,
    0x04,0x00,0x00,0x10,0xb0,0x04,0x00,0x00,0x10,0xc0,0x04,0x00,
    0x00,0x10,0x00,0x04,0x00,0x00,0xf8,0xff,0x0f,0x00,0x00,0x18,
    0x00,0x0c,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0x20,
    0x01,0x00,0x00,0x00,0x20,0x41,0x00,0x00,0x00,0xc0,0x70,0x00,
    0x00,0x00,0x00,0x4c,0x00,0x00,0x00,0x00,0x46,0x00,0x00,0x00,
    0x00,0x58,0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00};

CUstr mp_cpdOpen_small[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0xfc,0x1f,0x00,0x04,0x10,0x00,
    0xf4,0x10,0x00,0x54,0x10,0x00,0x34,0x10,0x00,0x94,0x17,0x00,
    0x84,0x14,0x00,0x84,0x17,0x00,0x04,0x10,0x00,0xfc,0x1f,0x00,
    0x00,0x00,0x00,0x00,0xf0,0x00,0x00,0x50,0x00,0x00,0x30,0x00,
    0x00,0x90,0x07,0x00,0x80,0x04,0x00,0x80,0x07,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00};

/*======================================================================*/
